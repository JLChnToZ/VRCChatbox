name: Build Desktop App

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      configuration:
        description: 'Build configuration (Debug or Release)'
        required: false
        default: 'Release'
      runtime:
        description: 'Runtime identifier (e.g. win-x64, win-x86)'
        required: false
        default: 'win-x64'
      create_release:
        description: 'Create a GitHub Release and upload published files? (true/false)'
        required: false
        default: 'false'
      release_tag:
        description: 'Tag for the release (e.g. v1.2.3). If empty, a tag will be generated.'
        required: false
        default: ''
      release_name:
        description: 'Release name/title'
        required: false
        default: ''

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore NuGet packages
        run: dotnet restore VRCChatboxApp.sln

      - name: Build
        run: dotnet build VRCChatboxApp.sln -c ${{ github.event.inputs.configuration }} --no-restore

      - name: Publish (self-contained single-file)
        run: |
          dotnet publish ./VRCChatboxApp.csproj -c ${{ github.event.inputs.configuration }} -r ${{ github.event.inputs.runtime }} --self-contained true /p:PublishSingleFile=true -o ./publish/${{ github.event.inputs.runtime }}

      - name: Upload published artifact
        uses: actions/upload-artifact@v4
        with:
          name: ChatboxApp-${{ github.event.inputs.runtime }}
          path: ./publish/${{ github.event.inputs.runtime }}

      - name: Resolve release tag
        if: ${{ github.event.inputs.create_release == 'true' }}
        id: resolve_tag
        run: |
          if ([string]::IsNullOrEmpty('${{ github.event.inputs.release_tag }}')) {
            echo "resolved_tag=v${{ github.run_number }}" >> $GITHUB_OUTPUT
          } else {
            echo "resolved_tag=${{ github.event.inputs.release_tag }}" >> $GITHUB_OUTPUT
          }
        shell: pwsh

      - name: Package published files
        if: ${{ github.event.inputs.create_release == 'true' }}
        run: |
          $pub = "./publish/${{ github.event.inputs.runtime }}"
          $zip = "$pub.zip"
          if (Test-Path $zip) { Remove-Item $zip }
          Compress-Archive -Path "$pub/*" -DestinationPath $zip
        shell: pwsh

      - name: Create GitHub Release
        if: ${{ github.event.inputs.create_release == 'true' }}
        id: create_release
        uses: softprops/action-gh-release@v2.4.2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.resolve_tag.outputs.resolved_tag }}
          name: ${{ github.event.inputs.release_name }}
          body: 'Automated prerelease generated by workflow'
          draft: true
          prerelease: true
          files: ./publish/${{ github.event.inputs.runtime }}.zip
